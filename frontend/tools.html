<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å…·åˆ—è¡¨ - MCP Web æ™ºèƒ½åŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/tools.css">
    <script src="js/config.js"></script>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <h1 class="app-title">ğŸ› ï¸ å·¥å…·åˆ—è¡¨</h1>
                <div class="header-actions">
                    <a href="index.html" class="btn btn-primary">è¿”å›èŠå¤©</a>
                </div>
            </div>
        </header>

        <main class="tools-container">
            <a href="index.html" class="back-link">
                â† è¿”å›èŠå¤©ç•Œé¢
            </a>

            <div id="toolsList">
                <div class="loading-container">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">â³</div>
                    æ­£åœ¨åŠ è½½å·¥å…·åˆ—è¡¨...
                </div>
            </div>
        </main>
    </div>

    <script>
        // åŠ è½½å·¥å…·åˆ—è¡¨
        async function loadTools() {
            try {
                // ç¡®ä¿é…ç½®å·²åŠ è½½
                if (!window.configManager.isLoaded) {
                    await window.configManager.loadConfig();
                }
                
                // è·å–APIåœ°å€ - æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                const timestamp = new Date().getTime();
                const apiUrl = window.configManager.getFullApiUrl('/api/tools') + '?t=' + timestamp;
                console.log('ğŸ”— æ­£åœ¨è¯·æ±‚å·¥å…·åˆ—è¡¨:', apiUrl);
                
                // æ·»åŠ æ— ç¼“å­˜å¤´
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                const result = await response.json();
                
                if (result.success) {
                    displayTools(result.data);
                } else {
                    showError('åŠ è½½å·¥å…·åˆ—è¡¨å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½å·¥å…·å¤±è´¥:', error);
                showError('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„åç«¯åœ°å€');
            }
        }
        
        function displayTools(data) {
            const toolsList = document.getElementById('toolsList');
            
            if (!data.servers || Object.keys(data.servers).length === 0) {
                toolsList.innerHTML = `
                    <div class="error-container">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“­</div>
                        <h2>æš‚æ— å¯ç”¨å·¥å…·</h2>
                        <p>è¯·æ£€æŸ¥ MCP æœåŠ¡å™¨é…ç½®</p>
                    </div>
                `;
                return;
            }
            
            // æ„å»ºé¡µé¢å†…å®¹
            let html = `
                <div class="stats-summary">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-number">${data.total_tools || 0}</span>
                            <div class="stat-label">æ€»å·¥å…·æ•°</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${data.server_count || 0}</span>
                            <div class="stat-label">MCP æœåŠ¡å™¨</div>
                        </div>
                        <div class="stat-item">
                            <button onclick="toggleAllServerGroups()" class="btn btn-secondary" style="padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; background: #e2e8f0; color: #2d3748; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease;">
                                <span id="toggle-all-text">å…¨éƒ¨æŠ˜å </span>
                            </button>
                            <div class="stat-label">å¿«é€Ÿæ“ä½œ</div>
                        </div>
                    </div>
                </div>
            `;
            
            // æŒ‰æœåŠ¡å™¨åˆ†ç»„æ˜¾ç¤ºå·¥å…·
            Object.values(data.servers).forEach(server => {
                html += `
                    <div class="server-group">
                        <div class="server-header" onclick="toggleServerGroup('${server.name}')">
                            <h2 class="server-name">
                                <span class="server-toggle" id="toggle-${server.name}">â–¼</span>
                                ğŸ”— ${escapeHtml(server.name)}
                            </h2>
                            <div class="server-info">
                                <span class="tool-count-badge">${server.tool_count} ä¸ªå·¥å…·</span>
                                <span style="color: #a0aec0; font-size: 0.75rem;">ç‚¹å‡»æŠ˜å /å±•å¼€</span>
                            </div>
                        </div>
                        
                        <div class="tools-grid" id="tools-${server.name}">
                            ${server.tools.map(tool => generateToolCard(tool)).join('')}
                        </div>
                    </div>
                `;
            });
            
            toolsList.innerHTML = html;
        }
        
        function generateToolCard(tool) {
            const hasParams = tool.parameters && Object.keys(tool.parameters).length > 0;
            
            return `
                <div class="tool-card">
                    <div class="tool-name">
                        <span class="tool-icon">âš™ï¸</span>
                        ${escapeHtml(tool.name)}
                    </div>
                    <div class="tool-description">
                        ${escapeHtml(tool.description || 'æš‚æ— æè¿°')}
                    </div>
                    
                    ${hasParams ? `
                        <div class="tool-params">
                            <strong style="color: #2d3748; margin-bottom: 0.5rem; display: block;">å‚æ•°åˆ—è¡¨:</strong>
                            ${Object.entries(tool.parameters).map(([name, param]) => {
                                const isRequired = tool.required && tool.required.includes(name);
                                return `
                                    <div class="param-item">
                                        <div style="margin-bottom: 0.25rem;">
                                            <span class="param-name">${escapeHtml(name)}</span>
                                            <span class="${isRequired ? 'param-required' : 'param-optional'}">
                                                ${isRequired ? 'å¿…éœ€' : 'å¯é€‰'}
                                            </span>
                                        </div>
                                        ${param.description ? `<div style="margin-bottom: 0.25rem;">${escapeHtml(param.description)}</div>` : ''}
                                        ${param.type ? `<div class="param-type">ç±»å‹: ${escapeHtml(param.type)}</div>` : ''}
                                        ${param.enum ? `<div class="param-enum">å¯é€‰å€¼: [${param.enum.map(v => escapeHtml(String(v))).join(', ')}]</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div style="color: #a0aec0; font-style: italic; padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                            ğŸ¯ æ­¤å·¥å…·æ— éœ€å‚æ•°
                        </div>
                    `}
                </div>
            `;
        }
        
        function showError(message) {
            const toolsList = document.getElementById('toolsList');
            toolsList.innerHTML = `
                <div class="error-container">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">âŒ</div>
                    <h2>${escapeHtml(message)}</h2>
                    <button onclick="loadTools()" class="btn btn-primary" style="margin-top: 1rem;">
                        ğŸ”„ é‡æ–°åŠ è½½
                    </button>
                </div>
            `;
        }
        
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                text = String(text);
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // åˆ‡æ¢æœåŠ¡å™¨åˆ†ç»„çš„æŠ˜å çŠ¶æ€
        function toggleServerGroup(serverName) {
            const toolsGrid = document.getElementById(`tools-${serverName}`);
            const toggleIcon = document.getElementById(`toggle-${serverName}`);
            
            if (!toolsGrid || !toggleIcon) return;
            
            const isCollapsed = toolsGrid.classList.contains('collapsed');
            
            if (isCollapsed) {
                // å±•å¼€
                toolsGrid.classList.remove('collapsed');
                toggleIcon.classList.remove('collapsed');
                toggleIcon.textContent = 'â–¼';
                
                // ä¿å­˜å±•å¼€çŠ¶æ€
                localStorage.setItem(`server-${serverName}-collapsed`, 'false');
            } else {
                // æŠ˜å 
                toolsGrid.classList.add('collapsed');
                toggleIcon.classList.add('collapsed');
                toggleIcon.textContent = 'â–¶';
                
                // ä¿å­˜æŠ˜å çŠ¶æ€
                localStorage.setItem(`server-${serverName}-collapsed`, 'true');
            }
            
            // æ›´æ–°å…¨å±€æŒ‰é’®æ–‡æœ¬
            updateToggleAllButtonText();
        }
        
        // æ¢å¤æœåŠ¡å™¨åˆ†ç»„çš„æŠ˜å çŠ¶æ€
        function restoreServerGroupStates() {
            // è·å–æ‰€æœ‰æœåŠ¡å™¨åˆ†ç»„
            document.querySelectorAll('.server-group').forEach(group => {
                const header = group.querySelector('.server-header');
                if (header && header.onclick) {
                    const onclickStr = header.getAttribute('onclick');
                    const match = onclickStr.match(/toggleServerGroup\('([^']+)'\)/);
                    if (match) {
                        const serverName = match[1];
                        const isCollapsed = localStorage.getItem(`server-${serverName}-collapsed`) === 'true';
                        
                        if (isCollapsed) {
                            const toolsGrid = document.getElementById(`tools-${serverName}`);
                            const toggleIcon = document.getElementById(`toggle-${serverName}`);
                            
                            if (toolsGrid && toggleIcon) {
                                toolsGrid.classList.add('collapsed');
                                toggleIcon.classList.add('collapsed');
                                toggleIcon.textContent = 'â–¶';
                            }
                        }
                    }
                }
            });
            
            // æ›´æ–°"å…¨éƒ¨æŠ˜å /å±•å¼€"æŒ‰é’®æ–‡æœ¬
            updateToggleAllButtonText();
        }
        
        // åˆ‡æ¢æ‰€æœ‰æœåŠ¡å™¨åˆ†ç»„
        function toggleAllServerGroups() {
            const allGroups = document.querySelectorAll('.tools-grid');
            const hasAnyExpanded = Array.from(allGroups).some(grid => !grid.classList.contains('collapsed'));
            
            allGroups.forEach(grid => {
                const serverId = grid.id.replace('tools-', '');
                const toggleIcon = document.getElementById(`toggle-${serverId}`);
                
                if (hasAnyExpanded) {
                    // å¦‚æœæœ‰å±•å¼€çš„ï¼Œå°±å…¨éƒ¨æŠ˜å 
                    grid.classList.add('collapsed');
                    if (toggleIcon) {
                        toggleIcon.classList.add('collapsed');
                        toggleIcon.textContent = 'â–¶';
                    }
                    localStorage.setItem(`server-${serverId}-collapsed`, 'true');
                } else {
                    // å¦‚æœå…¨éƒ¨æŠ˜å ï¼Œå°±å…¨éƒ¨å±•å¼€
                    grid.classList.remove('collapsed');
                    if (toggleIcon) {
                        toggleIcon.classList.remove('collapsed');
                        toggleIcon.textContent = 'â–¼';
                    }
                    localStorage.setItem(`server-${serverId}-collapsed`, 'false');
                }
            });
            
            updateToggleAllButtonText();
        }
        
        // æ›´æ–°"å…¨éƒ¨æŠ˜å /å±•å¼€"æŒ‰é’®æ–‡æœ¬
        function updateToggleAllButtonText() {
            const toggleAllText = document.getElementById('toggle-all-text');
            if (!toggleAllText) return;
            
            const allGroups = document.querySelectorAll('.tools-grid');
            const hasAnyExpanded = Array.from(allGroups).some(grid => !grid.classList.contains('collapsed'));
            
            toggleAllText.textContent = hasAnyExpanded ? 'å…¨éƒ¨æŠ˜å ' : 'å…¨éƒ¨å±•å¼€';
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–å·¥å…·åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', async () => {
            // æ¸…é™¤å¯èƒ½çš„ç¼“å­˜
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        if (name.includes('api') || name.includes('tools')) {
                            console.log('ğŸ§¹ æ¸…é™¤APIç¼“å­˜:', name);
                            caches.delete(name);
                        }
                    });
                });
            }
            
            // å¼ºåˆ¶åˆ·æ–°å·¥å…·åˆ—è¡¨
            await loadTools();
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿DOMæ¸²æŸ“å®Œæˆåå†æ¢å¤çŠ¶æ€
            setTimeout(restoreServerGroupStates, 100);
        });
    </script>
</body>
</html> 