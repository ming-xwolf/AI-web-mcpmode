<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å…· - MCP æ™ºèƒ½åŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/tools.css">
    <link rel="stylesheet" href="css/auth.css">
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <h1 class="app-title">ğŸ› ï¸ å·¥å…·</h1>
                <div class="header-actions">
                    <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
                    <div class="user-info" id="userInfo" style="display: none;">
                        <div class="user-avatar">
                            <span id="userInitial">U</span>
                        </div>
                        <div class="user-dropdown">
                            <button id="userDropdownBtn" class="btn btn-secondary">
                                <span id="userName">ç”¨æˆ·</span> â–¾
                            </button>
                            <div id="userDropdown" class="dropdown-menu" style="display:none">
                                <a href="#" id="userProfileBtn">ä¸ªäººèµ„æ–™</a>
                                <a href="#" id="userSettingsBtn">è®¾ç½®</a>
                                <hr>
                                <a href="#" id="logoutBtn">ç™»å‡º</a>
                            </div>
                        </div>
                    </div>

                    <!-- ç™»å½•æŒ‰é’® -->
                    <div class="auth-buttons" id="authButtons">
                        <a href="login.html" class="btn btn-primary">ç™»å½•</a>
                        <a href="register.html" class="btn btn-secondary">æ³¨å†Œ</a>
                    </div>
                    
                    <a href="index.html" class="btn btn-primary">è¿”å›å¯¹è¯</a>
                </div>
            </div>
        </header>

        <main class="tools-container">
            <a href="index.html" class="back-link">
â† è¿”å›èŠå¤©
            </a>

            <div id="toolsList">
                <div class="loading-container">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">â³</div>
                    æ­£åœ¨åŠ è½½å·¥å…·...
                </div>
            </div>
        </main>
    </div>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥è®¤è¯çŠ¶æ€
        document.addEventListener('DOMContentLoaded', async function() {
            const user = await checkAuthStatus();
            updateUIForAuthStatus(user);
            loadTools();
        });

        // æ›´æ–°UIä»¥åæ˜ è®¤è¯çŠ¶æ€
        function updateUIForAuthStatus(user) {
            const userInfo = document.getElementById('userInfo');
            const authButtons = document.getElementById('authButtons');
            const userName = document.getElementById('userName');
            const userInitial = document.getElementById('userInitial');

            if (user) {
                // ç”¨æˆ·å·²ç™»å½•
                userInfo.style.display = 'flex';
                authButtons.style.display = 'none';
                userName.textContent = user.username;
                userInitial.textContent = user.username.charAt(0).toUpperCase();
            } else {
                // ç”¨æˆ·æœªç™»å½•
                userInfo.style.display = 'none';
                authButtons.style.display = 'flex';
            }
        }

        // ç”¨æˆ·ä¸‹æ‹‰èœå•äº‹ä»¶
        document.addEventListener('click', function(e) {
            const userDropdownBtn = document.getElementById('userDropdownBtn');
            const userDropdown = document.getElementById('userDropdown');
            const logoutBtn = document.getElementById('logoutBtn');

            if (e.target === userDropdownBtn || userDropdownBtn.contains(e.target)) {
                e.preventDefault();
                userDropdown.style.display = userDropdown.style.display === 'none' ? 'block' : 'none';
            } else if (e.target === logoutBtn) {
                e.preventDefault();
                logout();
            } else {
                userDropdown.style.display = 'none';
            }
        });

        // åŠ è½½å·¥å…·åˆ—è¡¨
        async function loadTools() {
            try {
                // ç¡®ä¿é…ç½®å·²åŠ è½½
                if (!window.configManager.isLoaded) {
                    await window.configManager.loadConfig();
                }
                
                // è·å–APIåœ°å€ - æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                const timestamp = new Date().getTime();
                const apiUrl = window.configManager.getFullApiUrl('/api/tools') + '?t=' + timestamp;
                console.log('ğŸ”— Requesting tool list:', apiUrl);
                
                // å°½é‡é¿å…è§¦å‘é¢„æ£€è¯·æ±‚ï¼Œä½¿ç”¨ cache é€‰é¡¹è€Œä¸æ˜¯è‡ªå®šä¹‰å¤´
                let response;
                try {
                    response = await fetch(apiUrl, { method: 'GET', cache: 'no-store', mode: 'cors' });
                } catch (e1) {
                    // å…œåº•ï¼šåŒæºç›¸å¯¹è·¯å¾„ï¼ˆé€‚é…åå‘ä»£ç†åœºæ™¯ï¼‰
                    const fallbackUrl = `/api/tools?t=${timestamp}`;
                    console.warn('âš ï¸ Main address request failed, trying same-origin fallback:', fallbackUrl, e1);
                    response = await fetch(fallbackUrl, { method: 'GET', cache: 'no-store' });
                }
                const result = await response.json();
                
                if (result.success) {
                    displayTools(result.data);
                } else {
                    showError('å·¥å…·åˆ—è¡¨åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('Failed to load tools:', error);
                showError('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚è¯·æ£€æŸ¥é…ç½®ä¸­çš„åç«¯åœ°å€');
            }
        }
        
        function displayTools(data) {
            const toolsList = document.getElementById('toolsList');
            
            if (!data.servers || Object.keys(data.servers).length === 0) {
                toolsList.innerHTML = `
                    <div class="error-container">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“­</div>
                        <h2>æ²¡æœ‰å¯ç”¨çš„å·¥å…·</h2>
                        <p>è¯·æ£€æŸ¥ MCP æœåŠ¡å™¨é…ç½®</p>
                    </div>
                `;
                return;
            }
            
            // æ„å»ºé¡µé¢å†…å®¹
            let html = `
                <div class="stats-summary">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-number">${data.total_tools || 0}</span>
                            <div class="stat-label">å·¥å…·æ€»æ•°</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${data.server_count || 0}</span>
                            <div class="stat-label">MCP æœåŠ¡å™¨</div>
                        </div>
                        <div class="stat-item">
                            <button onclick="toggleAllServerGroups()" class="btn btn-secondary" style="padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; background: #e2e8f0; color: #2d3748; cursor: pointer; font-size: 0.875rem; transition: all 0.2s ease;">
                                <span id="toggle-all-text">å…¨éƒ¨æŠ˜å </span>
                            </button>
                            <div class="stat-label">å¿«æ·æ“ä½œ</div>
                        </div>
                    </div>
                </div>
            `;
            
            // æŒ‰æœåŠ¡å™¨åˆ†ç»„æ˜¾ç¤ºå·¥å…·
            Object.values(data.servers).forEach(server => {
                html += `
                    <div class="server-group">
                        <div class="server-header" onclick="toggleServerGroup('${server.name}')">
                            <h2 class="server-name">
                                <span class="server-toggle" id="toggle-${server.name}">â–¼</span>
                                ğŸ”— ${escapeHtml(server.name)}
                            </h2>
                            <div class="server-info">
                                <span class="tool-count-badge">${server.tool_count} ä¸ªå·¥å…·</span>
                                <span style="color: #a0aec0; font-size: 0.75rem;">ç‚¹å‡»æŠ˜å /å±•å¼€</span>
                            </div>
                        </div>
                        
                        <div class="tools-grid" id="tools-${server.name}">
                            ${server.tools.map(tool => generateToolCard(tool)).join('')}
                        </div>
                    </div>
                `;
            });
            
            toolsList.innerHTML = html;
        }
        
        function generateToolCard(tool) {
            const hasParams = tool.parameters && Object.keys(tool.parameters).length > 0;
            
            return `
                <div class="tool-card">
                    <div class="tool-name">
                        <span class="tool-icon">âš™ï¸</span>
                        ${escapeHtml(tool.name)}
                    </div>
                    <div class="tool-description">
                        ${escapeHtml(tool.description || 'No description')}
                    </div>
                    
                    ${hasParams ? `
                        <div class="tool-params">
                            <strong style="color: #2d3748; margin-bottom: 0.5rem; display: block;">Parameters:</strong>
                            ${Object.entries(tool.parameters).map(([name, param]) => {
                                const isRequired = tool.required && tool.required.includes(name);
                                return `
                                    <div class="param-item">
                                        <div style="margin-bottom: 0.25rem;">
                                            <span class="param-name">${escapeHtml(name)}</span>
                                            <span class="${isRequired ? 'param-required' : 'param-optional'}">
                                                ${isRequired ? 'å¿…å¡«' : 'å¯é€‰'}
                                            </span>
                                        </div>
                                        ${param.description ? `<div style="margin-bottom: 0.25rem;">${escapeHtml(param.description)}</div>` : ''}
                                        ${param.type ? `<div class="param-type">ç±»å‹ï¼š${escapeHtml(param.type)}</div>` : ''}
                                        ${param.enum ? `<div class="param-enum">å–å€¼ï¼š[${param.enum.map(v => escapeHtml(String(v))).join(', ')}]</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div style="color: #a0aec0; font-style: italic; padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                            ğŸ¯ æ— éœ€å‚æ•°
                        </div>
                    `}
                </div>
            `;
        }
        
        function showError(message) {
            const toolsList = document.getElementById('toolsList');
            toolsList.innerHTML = `
                <div class="error-container">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">âŒ</div>
                    <h2>${escapeHtml(message)}</h2>
                    <button onclick="loadTools()" class="btn btn-primary" style="margin-top: 1rem;">
                        ğŸ”„ é‡æ–°åŠ è½½
                    </button>
                </div>
            `;
        }
        
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                text = String(text);
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // åˆ‡æ¢æœåŠ¡å™¨åˆ†ç»„çš„æŠ˜å çŠ¶æ€
        function toggleServerGroup(serverName) {
            const toolsGrid = document.getElementById(`tools-${serverName}`);
            const toggleIcon = document.getElementById(`toggle-${serverName}`);
            
            if (!toolsGrid || !toggleIcon) return;
            
            const isCollapsed = toolsGrid.classList.contains('collapsed');
            
            if (isCollapsed) {
                // å±•å¼€
                toolsGrid.classList.remove('collapsed');
                toggleIcon.classList.remove('collapsed');
                toggleIcon.textContent = 'â–¼';
                
                // ä¿å­˜å±•å¼€çŠ¶æ€
                localStorage.setItem(`server-${serverName}-collapsed`, 'false');
            } else {
                // æŠ˜å 
                toolsGrid.classList.add('collapsed');
                toggleIcon.classList.add('collapsed');
                toggleIcon.textContent = 'â–¶';
                
                // ä¿å­˜æŠ˜å çŠ¶æ€
                localStorage.setItem(`server-${serverName}-collapsed`, 'true');
            }
            
            // æ›´æ–°å…¨å±€æŒ‰é’®æ–‡æœ¬
            updateToggleAllButtonText();
        }
        
        // æ¢å¤æœåŠ¡å™¨åˆ†ç»„çš„æŠ˜å çŠ¶æ€
        function restoreServerGroupStates() {
            // è·å–æ‰€æœ‰æœåŠ¡å™¨åˆ†ç»„
            document.querySelectorAll('.server-group').forEach(group => {
                const header = group.querySelector('.server-header');
                if (header && header.onclick) {
                    const onclickStr = header.getAttribute('onclick');
                    const match = onclickStr.match(/toggleServerGroup\('([^']+)'\)/);
                    if (match) {
                        const serverName = match[1];
                        const isCollapsed = localStorage.getItem(`server-${serverName}-collapsed`) === 'true';
                        
                        if (isCollapsed) {
                            const toolsGrid = document.getElementById(`tools-${serverName}`);
                            const toggleIcon = document.getElementById(`toggle-${serverName}`);
                            
                            if (toolsGrid && toggleIcon) {
                                toolsGrid.classList.add('collapsed');
                                toggleIcon.classList.add('collapsed');
                                toggleIcon.textContent = 'â–¶';
                            }
                        }
                    }
                }
            });
            
            // æ›´æ–°"å…¨éƒ¨æŠ˜å /å±•å¼€"æŒ‰é’®æ–‡æœ¬
            updateToggleAllButtonText();
        }
        
        // åˆ‡æ¢æ‰€æœ‰æœåŠ¡å™¨åˆ†ç»„
        function toggleAllServerGroups() {
            const allGroups = document.querySelectorAll('.tools-grid');
            const hasAnyExpanded = Array.from(allGroups).some(grid => !grid.classList.contains('collapsed'));
            
            allGroups.forEach(grid => {
                const serverId = grid.id.replace('tools-', '');
                const toggleIcon = document.getElementById(`toggle-${serverId}`);
                
                if (hasAnyExpanded) {
                    // å¦‚æœæœ‰å±•å¼€çš„ï¼Œå°±å…¨éƒ¨æŠ˜å 
                    grid.classList.add('collapsed');
                    if (toggleIcon) {
                        toggleIcon.classList.add('collapsed');
                        toggleIcon.textContent = 'â–¶';
                    }
                    localStorage.setItem(`server-${serverId}-collapsed`, 'true');
                } else {
                    // å¦‚æœå…¨éƒ¨æŠ˜å ï¼Œå°±å…¨éƒ¨å±•å¼€
                    grid.classList.remove('collapsed');
                    if (toggleIcon) {
                        toggleIcon.classList.remove('collapsed');
                        toggleIcon.textContent = 'â–¼';
                    }
                    localStorage.setItem(`server-${serverId}-collapsed`, 'false');
                }
            });
            
            updateToggleAllButtonText();
        }
        
        // æ›´æ–°"å…¨éƒ¨æŠ˜å /å±•å¼€"æŒ‰é’®æ–‡æœ¬
        function updateToggleAllButtonText() {
            const toggleAllText = document.getElementById('toggle-all-text');
            if (!toggleAllText) return;
            
            const allGroups = document.querySelectorAll('.tools-grid');
            const hasAnyExpanded = Array.from(allGroups).some(grid => !grid.classList.contains('collapsed'));
            
            toggleAllText.textContent = hasAnyExpanded ? 'å…¨éƒ¨æŠ˜å ' : 'å…¨éƒ¨å±•å¼€';
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–å·¥å…·åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', async () => {
            // æ¸…é™¤å¯èƒ½çš„ç¼“å­˜
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        if (name.includes('api') || name.includes('tools')) {
                            console.log('ğŸ§¹ Clearing API cache:', name);
                            caches.delete(name);
                        }
                    });
                });
            }
            
            // å¼ºåˆ¶åˆ·æ–°å·¥å…·åˆ—è¡¨
            await loadTools();
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿DOMæ¸²æŸ“å®Œæˆåå†æ¢å¤çŠ¶æ€
            setTimeout(restoreServerGroupStates, 100);
        });
    </script>
</body>
</html>